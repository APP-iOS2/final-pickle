# workflow ì˜ ì´ë¦„
name: Run Test

on:
  # dev ë¸Œëœì¹˜ì— pull request ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚¬ì„ë•Œ í•´ë‹¹ workflow ë¥¼ trigger
  pull_request:
    branches: [ dev ]

# workflowì˜ ì‹¤í–‰ì€ í•˜ë‚˜ ì´ìƒì˜ jobìœ¼ë¡œ êµ¬ì„± ë¨
jobs:
  # ì´ workflow ëŠ” "build" ë¼ëŠ” single job ìœ¼ë¡œ êµ¬ì„±
  build:
    # jobì´ ì‹¤í–‰ë  í™˜ê²½ - ìµœì‹  mac os
    runs-on: macos-13

    # Stepì€ jobì˜ ì¼ë¶€ë¡œ ì‹¤í–‰ë  ì¼ë ¨ì˜ taskë“¤ì„ ë‚˜íƒ€ëƒ„
    steps:
    # uses í‚¤ì›Œë“œë¥¼ í†µí•´ Github Actionsì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ì•¡ì…˜ì„ ì‚¬ìš© ê°€ëŠ¥. ì•„ë˜ ì•¡ì…˜ì€ repository ì— ì²´í¬ì•„ì›ƒí•˜ëŠ” ê²ƒ
    - uses: actions/checkout@v2
    # xcode 15.0-beta ì„ íƒ
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0.1'
    # shell ì´ìš©í•´ì„œ í•˜ë‚˜ì˜ command ìˆ˜í–‰
    - name: Start xcode build ğŸ› 
      run: |
        xcodebuild clean test -project Pickle/Pickle.xcodeproj -scheme Pickle -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.0.1'
    # slack ì— ì•Œë¦¼ ë³´ë‚´ê¸°
    - name: action-slack
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        author_name: Github Action Test # default: 8398a7@action-slack
        fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }} # required
      if: always() # Pick up events even if the job fails or is canceled.

    # # DESCRIBE: ë¹Œë“œ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰ë˜ëŠ” step
    # - name: If build fail
    #     # ì´ì „ stepì´ ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì´ stepì„ ì‹¤í–‰ì‹œí‚¤ëŠ” syntax
    #   if: ${{ failure() }}
    #   uses: actions/github-script@v6
    #   with:
    #     github-token: ${{ github.token }}
    #     script: |
    #         const pull_number = ${{ github.event.pull_request.number }}
    #         const updated_title = `[BUILD FAIL] ${{ github.event.pull_request.title }}`
    #         await github.rest.pulls.createReview({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           pull_number: pull_number,
    #           body: 'ë¹Œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
    #           event: 'REQUEST_CHANGES'
    #         })
    #         await github.rest.pulls.update({
    #           owner: context.repo.owner,
    #           repo: context.repo.repo,
    #           pull_number: pull_number,
    #           title: updated_title,
    #           state: 'closed'
    #         })
